{
  "code" : "org.meveo.script.ListServerNetworks",
  "inputs" : [ ],
  "outputs" : [ ],
  "generateOutputs" : false,
  "type" : "JAVA",
  "transactionType" : "SAME",
  "script" : "package org.meveo.script;\r\n\r\nimport java.util.Map;\r\n\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport org.meveo.service.storage.RepositoryService;\r\nimport org.meveo.model.storage.Repository;\r\nimport org.meveo.model.customEntities.ServiceProvider;\r\nimport org.meveo.persistence.CrossStorageService;\r\nimport org.meveo.service.custom.CustomEntityTemplateService;\r\nimport org.meveo.api.exception.EntityDoesNotExistsException;\r\nimport org.meveo.model.customEntities.CustomEntityTemplate;\r\nimport java.util.List;\r\nimport java.util.ArrayList;\r\nimport com.google.gson.JsonObject;\r\nimport com.google.gson.JsonArray;\r\nimport com.google.gson.JsonElement;\r\nimport org.meveo.credentials.CredentialHelperService;\r\nimport org.meveo.model.customEntities.Credential;\r\nimport org.meveo.script.openstack.CheckOVHToken;\r\nimport org.meveo.script.openstack.OpenstackAPI;\r\nimport org.meveo.model.customEntities.ServerNetwork;\r\nimport java.time.OffsetDateTime;\r\n\r\npublic class ListServerNetworks extends Script {\r\n\r\n    private static final Logger log = LoggerFactory.getLogger(ListServerNetworks.class);\r\n\r\n    private CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);\r\n\r\n    private RepositoryService repositoryService = getCDIBean(RepositoryService.class);\r\n\r\n    private Repository defaultRepo = repositoryService.findDefaultRepository();\r\n\r\n    private CrossStorageService crossStorageService = getCDIBean(CrossStorageService.class);\r\n\r\n    private CustomEntityTemplateService customEntityTemplateService = getCDIBean(CustomEntityTemplateService.class);\r\n\r\n    private CheckOVHToken checkOVHToken = new CheckOVHToken();\r\n\r\n    private OpenstackAPI openstackAPI = new OpenstackAPI();\r\n\t\r\n\t@Override\r\n\tpublic void execute(Map<String, Object> parameters) throws BusinessException {\r\n\t\tsuper.execute(parameters);\r\n        ServiceProvider sp = new ServiceProvider();\r\n        String codeClass = sp.getClass().getSimpleName();\r\n        CustomEntityTemplate cet = customEntityTemplateService.findByCode(codeClass);\r\n        try {\r\n            List<Map<String, Object>> providers = crossStorageService.find(defaultRepo, cet, null);\r\n            for (Map<String, Object> provider : providers) {\r\n                log.info(provider.toString());\r\n                ServiceProvider matchingProvider = crossStorageApi.find(defaultRepo, ServiceProvider.class).by(\"uuid\", provider.get(\"uuid\").toString()).getResult();\r\n                Credential credential = CredentialHelperService.getCredential(matchingProvider.getApiBaseUrl(), crossStorageApi, defaultRepo);\r\n              \tif (credential.getDomainName().equalsIgnoreCase(\"cloud.ovh.net\")) {\r\n                    checkOVHToken.checkOVHToken(credential, matchingProvider);\r\n                    List<JsonObject> networks = openstackAPI.networkAPI(\"networks\", credential, null, \"get\", \"network\");\r\n                    for (JsonObject networkObj : networks) {\r\n                        ServerNetwork network = new ServerNetwork();\r\n                      \tnetwork.setUuid(networkObj.get(\"id\").getAsString());\r\n                      \tnetwork.setName(networkObj.get(\"name\").getAsString());\r\n                      \tArrayList<String> subnets = new ArrayList<>();\r\n                      \tJsonArray jsonArray = (JsonArray)networkObj.get(\"subnets\");\r\n                      \tif (jsonArray != null) {\r\n                            for (JsonElement o : jsonArray){ \r\n                            \tsubnets.add(o.getAsString());\r\n                            }\r\n                        }\r\n                      \tnetwork.setSubnet(subnets);\r\n                      \tnetwork.setCreationDate(OffsetDateTime.parse(networkObj.get(\"created_at\").getAsString()).toInstant());\r\n                      \tnetwork.setLastUpdated(OffsetDateTime.parse(networkObj.get(\"updated_at\").getAsString()).toInstant());\r\n                        try {\r\n                            crossStorageApi.createOrUpdate(defaultRepo, network);\r\n                        } catch (Exception ex) {\r\n                            log.error(\"error creating network {} :{}\", network.getUuid(), ex.getMessage());\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        } catch (EntityDoesNotExistsException ex) {\r\n            log.error(\"Entity does not exist : {} : {}\", codeClass, ex.getMessage());\r\n        }\r\n\t}\r\n\t\r\n}",
  "executionRoles" : [ ],
  "sourcingRoles" : [ ],
  "mavenDependencies" : [ ],
  "importScriptInstances" : [ {
    "code" : "org.meveo.script.openstack.OpenstackAPI",
    "inputs" : [ ],
    "outputs" : [ ],
    "generateOutputs" : false,
    "type" : "JAVA",
    "transactionType" : "SAME",
    "script" : "package org.meveo.script.openstack;\r\n\r\nimport java.util.Map;\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\nimport javax.ws.rs.client.*;\r\nimport javax.ws.rs.core.*;\r\nimport com.google.gson.*;\r\nimport java.util.List;\r\nimport java.util.ArrayList;\r\nimport org.meveo.model.customEntities.Credential;\r\n\r\npublic class OpenstackAPI extends Script {\r\n\r\n    private static final Logger log = LoggerFactory.getLogger(ListOVHServersScript.class);\r\n\r\n    private String computeBaseAPI = \"https://compute.gra11.cloud.ovh.net/v2.1/\";\r\n\r\n    private String networkBaseAPI = \"https://network.compute.gra11.cloud.ovh.net/v2.0/\";\r\n\r\n    private String imageBaseAPI = \"https://image.compute.gra11.cloud.ovh.net/v2/\";\r\n\r\n    private String identityBaseAPI = \"https://auth.cloud.ovh.net/\";\r\n\r\n    /**\r\n     * Do all of compute api call\r\n     * @param url the path of the call\r\n     * @param token the token currently used by the api\r\n     * @param jsonBody of the request. Can be null if no body is needed\r\n     * @param methodType GET, POST, DELETE, PUT\r\n     * @param objReturn to return is the json response\r\n     * @return the list of json object\r\n     * @throws if the methodType used is not supported\r\n     */\r\n    public List<JsonObject> computeAPI(String url, Credential token, String jsonBody, String methodType, String objReturn) throws BusinessException {\r\n        List<JsonObject> res = new ArrayList<>();\r\n        Client client = ClientBuilder.newClient();\r\n        if (methodType.equalsIgnoreCase(\"get\")) {\r\n            WebTarget target = client.target(this.computeBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).get();\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"post\")) {\r\n            WebTarget target = client.target(this.computeBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).post(Entity.json(jsonBody));\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"delete\")) {\r\n            WebTarget target = client.target(this.computeBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).delete();\r\n            String value = response.readEntity(String.class);\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"put\")) {\r\n          \t//TODO\r\n        } else {\r\n            throw new BusinessException(\"Cannot found \" + methodType + \" in method type request. Available methods : get, post, delete, put\");\r\n        }\r\n        client.close();\r\n        return res;\r\n    }\r\n\r\n    /**\r\n     * Do all of network api call\r\n     * @param url the path of the call\r\n     * @param token the token currently used by the api\r\n     * @param jsonBody of the request. Can be null if no body is needed\r\n     * @param methodType GET, POST, DELETE, PUT\r\n     * @param objReturn to return is the json response\r\n     * @return the list of json object\r\n     * @throws if the methodType used is not supported\r\n     */\r\n    public List<JsonObject> networkAPI(String url, Credential token, String jsonBody, String methodType, String objReturn) throws BusinessException {\r\n        List<JsonObject> res = new ArrayList<>();\r\n        Client client = ClientBuilder.newClient();\r\n      \tif (methodType.equalsIgnoreCase(\"get\")) {\r\n            WebTarget target = client.target(this.networkBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).get();\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n        \tresponse.close();\r\n        } else if (methodType.equalsIgnoreCase(\"post\")) {\r\n            WebTarget target = client.target(this.networkBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).post(Entity.json(jsonBody));\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n        \tresponse.close();\r\n        } else if (methodType.equalsIgnoreCase(\"delete\")) {\r\n            WebTarget target = client.target(this.networkBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).delete();\r\n            String value = response.readEntity(String.class);\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"put\")) {\r\n          \t//TODO\r\n        } else {\r\n            throw new BusinessException(\"Cannot found \" + methodType + \" in method type request. Available methods : get, post, delete, put\");\r\n        }\r\n        client.close();\r\n        return res;\r\n    }\r\n\r\n    /**\r\n     * Do all of image api call\r\n     * @param url the path of the call\r\n     * @param token the token currently used by the api\r\n     * @param jsonBody of the request. Can be null if no body is needed\r\n     * @param methodType GET, POST, DELETE, PUT\r\n     * @param objReturn to return is the json response\r\n     * @return the list of json object\r\n     * @throws if the methodType used is not supported\r\n     */\r\n    public List<JsonObject> imageAPI(String url, Credential token, String jsonBody, String methodType, String objReturn) throws BusinessException {\r\n        List<JsonObject> res = new ArrayList<>();\r\n        Client client = ClientBuilder.newClient();\r\n      \tif (methodType.equalsIgnoreCase(\"get\")) {\r\n            WebTarget target = client.target(this.imageBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).get();\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"post\")) {\r\n            WebTarget target = client.target(this.imageBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).post(Entity.json(jsonBody));\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"delete\")) {\r\n            WebTarget target = client.target(this.imageBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).delete();\r\n            String value = response.readEntity(String.class);\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"put\")) {\r\n          \t//TODO\r\n        } else {\r\n            throw new BusinessException(\"Cannot found \" + methodType + \" in method type request. Available methods : get, post, delete, put\");\r\n        }\r\n        client.close();\r\n        return res;\r\n    }\r\n\r\n    /**\r\n     * Do all of identity api call\r\n     * @param url the path of the call\r\n     * @param token the token currently used by the api\r\n     * @param jsonBody of the request. Can be null if no body is needed\r\n     * @param methodType GET, POST, DELETE, PUT\r\n     * @param objReturn to return is the json response\r\n     * @return the list of json object\r\n     * @throws if the methodType used is not supported\r\n     */\r\n    public List<JsonObject> IdentityAPI(String url, Credential token, String jsonBody, String methodType, String objReturn) throws BusinessException {\r\n        List<JsonObject> res = new ArrayList<>();\r\n        Client client = ClientBuilder.newClient();\r\n      \tif (methodType.equalsIgnoreCase(\"get\")) {\r\n            WebTarget target = client.target(this.identityBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).get();\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"post\")) {\r\n            WebTarget target = client.target(this.identityBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).post(Entity.json(jsonBody));\r\n            String value = response.readEntity(String.class);\r\n            if (response.getStatus() < 300) {\r\n              \tString isList = \"\\\"\" + objReturn + \"s\\\": [\";\r\n                if (value.contains(isList)) {\r\n                  \tobjReturn += \"s\";\r\n                    JsonArray rootArray = new JsonParser().parse(value).getAsJsonObject().getAsJsonArray(objReturn);\r\n                    for (JsonElement element : rootArray) {\r\n                        JsonObject JObject = element.getAsJsonObject();\r\n                        res.add(JObject);\r\n                    }\r\n                } else {\r\n                    JsonObject JObject = new JsonParser().parse(value).getAsJsonObject();\r\n                    JObject = JObject.get(objReturn).getAsJsonObject();\r\n                  \tres.add(JObject);\r\n                }\r\n            }\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"delete\")) {\r\n            WebTarget target = client.target(this.identityBaseAPI + url);\r\n            Response response = target.request().header(\"X-Auth-Token\", token.getToken()).delete();\r\n            String value = response.readEntity(String.class);\r\n            response.close();\r\n        } else if (methodType.equalsIgnoreCase(\"put\")) {\r\n          \t//TODO\r\n        } else {\r\n            throw new BusinessException(\"Cannot found \" + methodType + \" in method type request. Available methods : get, post, delete, put\");\r\n        }\r\n        client.close();\r\n        return res;\r\n    }\r\n\r\n    @Override\r\n    public void execute(Map<String, Object> parameters) throws BusinessException {\r\n        super.execute(parameters);\r\n    }\r\n}\r\n",
    "executionRoles" : [ ],
    "sourcingRoles" : [ ],
    "mavenDependencies" : [ ],
    "importScriptInstances" : [ ]
  }, {
    "code" : "org.meveo.credentials.CredentialHelperService",
    "description" : "Helper function to build request with credentials",
    "inputs" : [ ],
    "outputs" : [ ],
    "generateOutputs" : false,
    "type" : "JAVA",
    "transactionType" : "SAME",
    "script" : "package org.meveo.credentials;\r\n\r\nimport java.util.Map;\r\n\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport javax.ws.rs.client.*;\r\n\r\nimport java.io.IOException;\r\nimport java.util.List;\r\nimport org.meveo.model.customEntities.Credential;\r\nimport org.meveo.model.storage.Repository;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport org.meveo.elresolver.ValueExpressionWrapper;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n\r\npublic class CredentialHelperService extends Script {\r\n  \r\n  private static final Logger log = LoggerFactory.getLogger(CredentialHelperService.class);\r\n\r\n    public static class LoggingFilter implements ClientRequestFilter {\r\n        @Override\r\n        public void filter(ClientRequestContext requestContext) throws IOException {\r\n            if(requestContext!=null){\r\n              if(requestContext.getEntity()!=null){\r\n                log.info(requestContext.getEntity().toString());\r\n              } else {\r\n                log.info(\"uri:{}\",requestContext.getUri());\r\n              }\r\n            }\r\n        }\r\n    }\r\n\r\n    public static Credential getCredential(String domain,CrossStorageApi crossStorageApiInstance,Repository repo){\r\n      List<Credential> matchigCredentials = crossStorageApiInstance.find(repo, Credential.class)\r\n                .by(\"domainName\", domain)\r\n\t\t\t\t.getResults();\r\n      if(matchigCredentials.size()>0){\r\n        return matchigCredentials.get(0);\r\n      } else {\r\n        return null;\r\n      }\r\n    }\r\n  \r\n    public static Invocation.Builder setCredential(Invocation.Builder invocBuilder,Credential credential) throws BusinessException {\r\n      String headerKey = credential.getHeaderKey();\r\n      String headerValue = credential.getHeaderValue();\r\n      try{\r\n        if(headerKey.contains(\"#{\")){\r\n          headerKey=ValueExpressionWrapper.evaluateToStringMultiVariable(headerKey,\"entity\",credential);\r\n        }\r\n        if(headerValue.contains(\"#{\")){\r\n          headerValue=ValueExpressionWrapper.evaluateToStringMultiVariable(headerValue,\"entity\",credential);\r\n        }\r\n      } catch(Exception e) {\r\n        throw new BusinessException(e);\r\n      }\r\n      return invocBuilder.header(headerKey, headerValue);\r\n    }\r\n  \r\n\t@Override\r\n\tpublic void execute(Map<String, Object> parameters) throws BusinessException {\r\n    }\r\n\t\r\n}",
    "executionRoles" : [ ],
    "sourcingRoles" : [ ],
    "mavenDependencies" : [ ],
    "importScriptInstances" : [ ]
  } ]
}