{
  "code" : "org.meveo.gandi.CreateDnsRecord",
  "description" : "Create DNS record",
  "inputs" : [ ],
  "outputs" : [ ],
  "generateOutputs" : false,
  "type" : "JAVA",
  "transactionType" : "SAME",
  "script" : "package org.meveo.gandi;\r\n\r\nimport java.time.Instant;\r\nimport java.util.Map;\r\n\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n\r\nimport javax.ws.rs.client.*;\r\nimport javax.ws.rs.core.*;\r\n\r\nimport org.meveo.model.customEntities.Credential;\r\nimport org.meveo.model.customEntities.DomainName;\r\nimport org.meveo.model.customEntities.DnsRecord;\r\nimport org.meveo.service.storage.RepositoryService;\r\nimport org.meveo.model.storage.Repository;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport org.meveo.credentials.CredentialHelperService;\r\nimport org.meveo.model.persistence.CEIUtils;\r\n\r\n\r\npublic class CreateDnsRecord extends Script {\r\n\t\r\n    private static final Logger log = LoggerFactory.getLogger(ListDomains.class);\r\n    private CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);\r\n\tprivate RepositoryService repositoryService = getCDIBean(RepositoryService.class);\r\n    private Repository defaultRepo = repositoryService.findDefaultRepository();\r\n\r\n\tstatic final private String GANDI_URL = \"api.gandi.net/v5/\";\r\n\r\n\t@Override\r\n\tpublic void execute(Map<String, Object> parameters) throws BusinessException {\r\n\t\tString action= (String)parameters.get(\"CONTEXT_ACTION\");\r\n\t\tDnsRecord record =  CEIUtils.ceiToPojo((org.meveo.model.customEntities.CustomEntityInstance)parameters.get(\"CONTEXT_ENTITY\"), DnsRecord.class);\r\n\t\tif(record.getDomainName()==null || record.getRecordType()==null || record.getName()==null \r\n\t\t|| record.getName().isEmpty() || record.getValue()==null || record.getValue()==null){\r\n\t\t\tthrow new BusinessException(\"invalid record\");\r\n\t\t}\r\n\t\tDomainName domainName = record.getDomainName();\r\n\t\tlog.info(\"action:{}, domain name uuid:{}\",action,domainName.getUuid());\r\n\t\tCredential credential  = CredentialHelperService.getCredential(GANDI_URL,crossStorageApi,defaultRepo);\r\n      \tif(credential==null){\r\n        \tthrow new BusinessException(\"No credential found for \"+GANDI_URL);\r\n      \t} else {\r\n        \tlog.info(\"using credential {} with username {}\",credential.getUuid(),credential.getUsername());\r\n      \t}\r\n\t\tClient client = ClientBuilder.newClient();\r\n\t\tclient.register(new CredentialHelperService.LoggingFilter());\r\n\t\tWebTarget target = client.target(\"https://api.gandi.net/v5/livedns/domains/\"+domainName.getNormedName()+\"/records\");\r\n\t\tString resp = \"{\\n\"\r\n\t\t+\"\\\"rrset_type\\\": \\\"\"+record.getRecordType()+\"\\\",\\n\"\r\n\t\t+\"\\\"rrset_name\\\": \\\"\"+record.getName()+\"\\\",\\n\"\r\n\t\t+\"\\\"rrset_values\\\": [\\\"\"+record.getValue()+\"\\\"]\\n\"\r\n\t\t+\"}\";\r\n\t\t\r\n\t\tResponse response = null;\r\n\t\tif(record.getLastSyncDate()==null){\r\n\t\t\tresponse = CredentialHelperService.setCredential(target.request(),credential).post(Entity.json(resp));\r\n\t\t} else {\r\n\t\t\tresponse = CredentialHelperService.setCredential(target.request(),credential).put(Entity.json(\"{\\\"items\\\":[\"+resp+\"]}\"));\r\n\t\t}\r\n\t\tString value = response.readEntity(String.class);\r\n\t\tlog.info(\"response  :\" + value);\r\n\t\tlog.debug(\"response status : {}\", response.getStatus());\r\n\t\tparameters.put(\"RESULT_GUI_MESSAGE\", \"Status: \"+response.getStatus()+\", response:\"+value);\r\n\t\tif(response.getStatus()==201){\r\n\t\t\trecord.setLastSyncDate(Instant.now());\r\n\t\t\ttry {\r\n\t\t\t\tcrossStorageApi.createOrUpdate(defaultRepo, record);\r\n\t\t\t} catch (Exception ex) {\r\n\t\t\t\tlog.error(\"error updating lastSyncDate record {} :{}\", record.getUuid(), ex.getMessage());\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}",
  "executionRoles" : [ ],
  "sourcingRoles" : [ ],
  "mavenDependencies" : [ ],
  "importScriptInstances" : [ {
    "code" : "org.meveo.credentials.CredentialHelperService",
    "description" : "Helper function to build request with credentials",
    "inputs" : [ ],
    "outputs" : [ ],
    "generateOutputs" : false,
    "type" : "JAVA",
    "transactionType" : "SAME",
    "script" : "package org.meveo.credentials;\r\n\r\nimport java.util.Map;\r\n\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport javax.ws.rs.client.*;\r\n\r\nimport java.io.IOException;\r\nimport java.util.List;\r\nimport org.meveo.model.customEntities.Credential;\r\nimport org.meveo.model.storage.Repository;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport org.meveo.elresolver.ValueExpressionWrapper;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\n\r\npublic class CredentialHelperService extends Script {\r\n  \r\n  private static final Logger log = LoggerFactory.getLogger(CredentialHelperService.class);\r\n\r\n    public static class LoggingFilter implements ClientRequestFilter {\r\n        @Override\r\n        public void filter(ClientRequestContext requestContext) throws IOException {\r\n            if(requestContext!=null){\r\n              if(requestContext.getEntity()!=null){\r\n                log.info(requestContext.getEntity().toString());\r\n              } else {\r\n                log.info(\"uri:{}\",requestContext.getUri());\r\n              }\r\n            }\r\n        }\r\n    }\r\n\r\n    public static Credential getCredential(String domain,CrossStorageApi crossStorageApiInstance,Repository repo){\r\n      List<Credential> matchigCredentials = crossStorageApiInstance.find(repo, Credential.class)\r\n                .by(\"domainName\", domain)\r\n\t\t\t\t.getResults();\r\n      if(matchigCredentials.size()>0){\r\n        return matchigCredentials.get(0);\r\n      } else {\r\n        return null;\r\n      }\r\n    }\r\n  \r\n    public static Invocation.Builder setCredential(Invocation.Builder invocBuilder,Credential credential) throws BusinessException {\r\n      String headerKey = credential.getHeaderKey();\r\n      String headerValue = credential.getHeaderValue();\r\n      try{\r\n        if(headerKey.contains(\"#{\")){\r\n          headerKey=ValueExpressionWrapper.evaluateToStringMultiVariable(headerKey,\"entity\",credential);\r\n        }\r\n        if(headerValue.contains(\"#{\")){\r\n          headerValue=ValueExpressionWrapper.evaluateToStringMultiVariable(headerValue,\"entity\",credential);\r\n        }\r\n      } catch(Exception e) {\r\n        throw new BusinessException(e);\r\n      }\r\n      return invocBuilder.header(headerKey, headerValue);\r\n    }\r\n  \r\n\t@Override\r\n\tpublic void execute(Map<String, Object> parameters) throws BusinessException {\r\n    }\r\n\t\r\n}",
    "executionRoles" : [ ],
    "sourcingRoles" : [ ],
    "mavenDependencies" : [ ],
    "importScriptInstances" : [ ]
  } ]
}