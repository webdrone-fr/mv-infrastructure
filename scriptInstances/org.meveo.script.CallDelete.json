{
  "code" : "org.meveo.script.CallDelete",
  "description" : "Delete server generic",
  "inputs" : [ ],
  "outputs" : [ ],
  "generateOutputs" : false,
  "type" : "JAVA",
  "transactionType" : "SAME",
  "script" : "package org.meveo.script;\r\n\r\nimport java.util.Map;\r\n\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport org.meveo.service.storage.RepositoryService;\r\nimport org.meveo.model.storage.Repository;\r\nimport org.meveo.model.customEntities.Credential;\r\nimport org.meveo.model.customEntities.ServiceProvider;\r\nimport org.meveo.model.customEntities.Server;\r\nimport org.meveo.model.persistence.CEIUtils;\r\nimport java.util.List;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport javax.faces.application.FacesMessage;\r\nimport javax.faces.context.FacesContext;\r\nimport org.meveo.script.openstack.DeleteOVHServerScript;\r\n\r\npublic class CallDelete extends Script {\r\n  \r\n    private static final Logger log = LoggerFactory.getLogger(CallListing.class);\r\n  \r\n    private CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);\r\n  \r\n    private RepositoryService repositoryService = getCDIBean(RepositoryService.class);\r\n  \r\n    private Repository defaultRepo = repositoryService.findDefaultRepository();\r\n  \r\n    private DeleteOVHServerScript deleteOVHServerScript = new DeleteOVHServerScript();\r\n  \r\n    private Credential getCredential(String domain) {\r\n        List<Credential> matchigCredentials = crossStorageApi.find(defaultRepo, Credential.class).by(\"domainName\", domain).getResults();\r\n        if (matchigCredentials.size() > 0) {\r\n            return matchigCredentials.get(0);\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\t\r\n\t@Override\r\n\tpublic void execute(Map<String, Object> parameters) throws BusinessException {\r\n\t\tsuper.execute(parameters);\r\n        log.info(\"calling CallDelete\");\r\n\t\tServer server = CEIUtils.ceiToPojo((org.meveo.model.customEntities.CustomEntityInstance)parameters.get(CONTEXT_ENTITY), Server.class);\r\n        ServiceProvider openstack = server.getProvider();\r\n        Credential credential = getCredential(openstack.getApiBaseUrl());\r\n        if (credential == null) {\r\n            throw new BusinessException(\"No credential found for \" + openstack.getApiBaseUrl()); \r\n        } else {\r\n        \tlog.info(\"using credential {} with username {}\", credential.getUuid(), credential.getUsername());\r\n        }\r\n        switch(credential.getDomainName()) {\r\n          case \"cloud.ovh.net\":\r\n            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_INFO, \"INFO : \", \"Deletion for OVH servers\"));\r\n            deleteOVHServerScript.DeleteServer(credential, openstack, server);\r\n            break;\r\n          case \"api.scaleway.com\":\r\n            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_INFO, \"INFO : \", \"Deletion for scaleway servers\"));\r\n            //create\r\n            break;\r\n          case \"api.gandi.net/v5/\":\r\n            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_INFO, \"INFO : \", \"Deletion for gandi servers\"));\r\n            //create\r\n            break;\r\n          default:\r\n            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_WARN, \"WArning : \", \"No Deletion found for \" + openstack.getCode()));\r\n\r\n        }\r\n\t}\r\n\t\r\n}",
  "executionRoles" : [ ],
  "sourcingRoles" : [ ],
  "mavenDependencies" : [ ],
  "importScriptInstances" : [ {
    "code" : "org.meveo.script.openstack.DeleteOVHServerScript",
    "description" : "Delete ovh dev server through openstack api",
    "inputs" : [ ],
    "outputs" : [ ],
    "generateOutputs" : false,
    "type" : "JAVA",
    "transactionType" : "SAME",
    "script" : "package org.meveo.script.openstack;\r\n\r\nimport java.util.Map;\r\nimport org.meveo.service.script.Script;\r\nimport org.meveo.admin.exception.BusinessException;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\nimport org.meveo.model.customEntities.ServiceProvider;\r\nimport org.meveo.model.customEntities.Server;\r\nimport org.meveo.model.customEntities.Credential;\r\nimport org.meveo.service.storage.RepositoryService;\r\nimport org.meveo.model.storage.Repository;\r\nimport javax.faces.application.FacesMessage;\r\nimport javax.faces.context.FacesContext;\r\nimport org.meveo.api.persistence.CrossStorageApi;\r\nimport javax.ws.rs.client.*;\r\nimport javax.ws.rs.core.*;\r\n\r\npublic class DeleteOVHServerScript extends Script {\r\n\r\n    private static final Logger log = LoggerFactory.getLogger(ListOVHServersScript.class);\r\n\r\n    private CrossStorageApi crossStorageApi = getCDIBean(CrossStorageApi.class);\r\n\r\n    private RepositoryService repositoryService = getCDIBean(RepositoryService.class);\r\n\r\n    private Repository defaultRepo = repositoryService.findDefaultRepository();\r\n\r\n    private CheckOVHToken checkOVHToken = new CheckOVHToken();\r\n\r\n    @Override\r\n    public void execute(Map<String, Object> parameters) throws BusinessException {\r\n        super.execute(parameters);\r\n    }\r\n\r\n    public void DeleteServer(Credential credential, ServiceProvider openstack, Server server) throws BusinessException {\r\n        if (server.getUuid() == null) {\r\n            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_WARN, \"Warning : \", \"server id not found for server: \" + server.getUuid()));\r\n            throw new BusinessException(\"Cannot delete server\");\r\n        }\r\n        boolean smt = server.getInstanceName().startsWith(\"dev-\");\r\n        log.info(\"condition to delete {}\", smt);\r\n        if (server.getInstanceName().startsWith(\"dev-\")) {\r\n            Client client = ClientBuilder.newClient();\r\n            log.info(\"uuid used {}\", server.getUuid());\r\n            WebTarget target = client.target(\"https://compute.\" + server.getZone() + \".cloud.ovh.net/v2.1/servers/\" + server.getUuid());\r\n            Response response = target.request().header(\"X-Auth-Token\", credential.getToken()).delete();\r\n        } else {\r\n            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_WARN, \"Warning : \", \"The server you're trying to delete is not a dev server : \" + server.getInstanceName()));\r\n        }\r\n    }\r\n}\r\n",
    "executionRoles" : [ ],
    "sourcingRoles" : [ ],
    "mavenDependencies" : [ ],
    "importScriptInstances" : [ ]
  } ]
}